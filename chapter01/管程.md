# 管程

### 什么是管程？

管程就是管理共享变量以及对共享变量的操作过程。

维基百科的解释是：

> **管程** (英语：Monitors，也称为**监视器**) 是一种程序结构，结构内的多个子程序（[对象](https://zh.wikipedia.org/wiki/对象_(计算机科学))或[模块](https://zh.wikipedia.org/wiki/模組_(程式設計))）形成的多个[工作线程](https://zh.wikipedia.org/wiki/工作_(資訊科學))互斥访问共享资源。这些共享资源一般是[硬件](https://zh.wikipedia.org/w/index.php?title=硬體裝置&action=edit&redlink=1)或一群[变量](https://zh.wikipedia.org/wiki/變數)。管程实现了在一个时间点，最多只有一个[线程](https://zh.wikipedia.org/wiki/线程)在执行管程的某个[子程序](https://zh.wikipedia.org/wiki/子程序)。

简单来说，管程提供了一种机制，线程可以临时放弃对互斥变量的访问，等待某些条件得到满足后，重新获得执行权恢复互斥访问。

并发编程有两个核心问题：互斥和同步。

1. 互斥锁实现资源的互斥访问
2. 条件变量实现线程见的同步

### MESA模型

MESA模型是Java中实现管程参考的模型，来看下是如何解决互斥和同步问题的。

#### 互斥问题

互斥问题就是同一时间，同一个资源只允许有一个线程访问。

管程的实现方案就是将共享变量和访问共享变量的方法封装起来，如图中的共享变量q，访问q的方法为enq()和deq()，这两个操作都要保证是互斥的，那么就可以安全的访问共享变量q了。

[管程互斥访问](../img/monitors.png)

#### 同步问题

对于许多应用场合，互斥操作是不够用的。线程可能需要等待某个条件P为真，才能继续执行。

管程中使用条件变量来解决同步问题。一个条件变量就是一个线程队列(queue), 其中的线程正等待某个条件变为真。

MESA管程模型如下图所示：

[MESA管程模型](../img/monitor2.png)

对于条件变量有两个操作：

1. wait c：被一个线程调用，以等待断言Pc后该为真线程可恢复执行。线程挂在该条件变量上等待时，不被认为是占用了管程。
2. singnal c：被一个线程调用，以指出条件Pc已为真。

#### wait()的使用方法

MESA管程模型中，wait使用方法如下，条件变量使用也可以参考：

````java
while(条件不满足) {
  wait();
}
````